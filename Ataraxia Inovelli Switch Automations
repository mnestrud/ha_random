blueprint:
  name: Ataraxia Lighting - Inovelli Switch Taps – Lights, Shades & LED (v0.5)
  description: >
    Inovelli Blue 2-in-1 (Zigbee2MQTT) multi-tap blueprint.
    - Config button single = Night settings (brightness/CT) → only if light_group provided
    - Config button double = Day settings (brightness/CT) → only if light_group provided
    - Up single / Down single = Adaptive Lighting (turn ON helper if OFF; 0.5s delay; call script only on that transition)
    - Up/Down held = Stop Adaptive (turn helper OFF)
    - Up double / Down double / Up triple = optional Shade scenes (and auto LED effects)
    LED effects are automatically sent on shade taps when the corresponding scene is set.

    Notes:
    • Uses Home Assistant 2024.8+ “actions” style.
    • Shade scenes are optional; if left blank, that key press does nothing (no scene, no LED).
    • Adaptive is enabled ONLY if BOTH 'adaptive_helper' and 'adaptive_script' are set.
    • Shade LED color switches to Red when ANY provided battery entity is below the low threshold.

  domain: automation
  author: mnestrud
  source_url: https://raw.githubusercontent.com/mnestrud/ha_random/main/Ataraxia%20Inovelli%20Switch%20Automations
  homeassistant:
    min_version: 2024.8.0

  input:
    inovelli_device:
      name: Inovelli switch (Zigbee2MQTT)
      description: Select the Inovelli Blue 2-in-1 controlling this room.
      selector:
        device:
          filter:
            - integration: mqtt
          multiple: false

    light_group:
      name: Target light / Zigbee group
      description: >
        Optional: If set, Config single/double will apply Night/Day brightness & color temp.
        If left blank, those button presses are disabled.
      default: []
      selector:
        entity:
          domain: light

    day_brightness:
      name: Daytime brightness (%)
      default: 80
      selector:
        number:
          min: 1
          max: 100
          mode: slider
          unit_of_measurement: "%"

    day_color_temp_k:
      name: Daytime color temperature (K)
      default: 4000
      selector:
        number:
          min: 2000
          max: 6500
          step: 50
          unit_of_measurement: "K"

    night_brightness:
      name: Nighttime brightness (%)
      default: 20
      selector:
        number:
          min: 1
          max: 100
          mode: slider
          unit_of_measurement: "%"

    night_color_temp_k:
      name: Nighttime color temperature (K)
      default: 2700
      selector:
        number:
          min: 1800
          max: 4000
          step: 50
          unit_of_measurement: "K"

    day_transition:
      name: Day transition (seconds)
      description: Smoother fade when applying Day settings.
      default: 0.4
      selector:
        number:
          min: 0
          max: 10
          step: 0.1
          unit_of_measurement: s

    night_transition:
      name: Night transition (seconds)
      description: Smoother fade when applying Night settings.
      default: 0.4
      selector:
        number:
          min: 0
          max: 10
          step: 0.1
          unit_of_measurement: s

    adaptive_helper:
      name: Adaptive Lighting helper (input_boolean)
      description: Must be set together with Adaptive script; otherwise adaptive is disabled.
      default: []
      selector:
        entity:
          filter:
            domain: input_boolean

    adaptive_script:
      name: Adaptive script to call
      description: Must be set together with Adaptive helper; otherwise adaptive is disabled. Accepts 'target_state' "ON"/"OFF".
      default: []
      selector:
        entity:
          filter:
            domain: script

    # Shade scenes — if left blank, that key press does nothing (and no LED effect)
    shade_up_scene:
      name: Shade UP scene (Up double)
      default: []
      selector:
        entity:
          filter:
            domain: scene

    shade_down_scene:
      name: Shade DOWN scene (Down double)
      default: []
      selector:
        entity:
          filter:
            domain: scene

    shade_shady_scene:
      name: Shade “Shady” scene (Up triple)
      default: []
      selector:
        entity:
          filter:
            domain: scene

    # LED EFFECTS (auto-run when corresponding shade scene is set)
    led_script:
      name: Inovelli LED effect script
      description: "Direct call to your LED script (must accept: led, color, level, effect, duration, target)."
      default: script.inovelli_blue_led_2025_1
      selector:
        entity:
          filter:
            domain: script

    led_color:
      name: LED color when batteries are OK
      default: Pink
      selector:
        text:

    led_level:
      name: LED level (1-100)
      default: 100
      selector:
        number:
          min: 1
          max: 100

    led_duration:
      name: LED duration (e.g., "10 Seconds")
      default: 10 Seconds
      selector:
        text:

    # Up to 4 optional battery entities. If ANY are below threshold, LED uses Red.
    battery_entity_1:
      name: Battery entity 1 (optional)
      default: []
      selector:
        entity:
          domain: sensor
          device_class: battery

    battery_entity_2:
      name: Battery entity 2 (optional)
      default: []
      selector:
        entity:
          domain: sensor
          device_class: battery

    battery_entity_3:
      name: Battery entity 3 (optional)
      default: []
      selector:
        entity:
          domain: sensor
          device_class: battery

    battery_entity_4:
      name: Battery entity 4 (optional)
      default: []
      selector:
        entity:
          domain: sensor
          device_class: battery

    battery_low_threshold:
      name: Battery low threshold (%)
      default: 30
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"

variables:
  inovelli_device_var: !input inovelli_device
  light_group_var: !input light_group

  adaptive_helper_var: !input adaptive_helper
  adaptive_script_var: !input adaptive_script

  shade_up_scene_var: !input shade_up_scene
  shade_down_scene_var: !input shade_down_scene
  shade_shady_scene_var: !input shade_shady_scene

  led_script_var: !input led_script
  led_color_var: !input led_color
  led_level_var: !input led_level
  led_duration_var: !input led_duration

  battery_entity_1_var: !input battery_entity_1
  battery_entity_2_var: !input battery_entity_2
  battery_entity_3_var: !input battery_entity_3
  battery_entity_4_var: !input battery_entity_4
  battery_low_threshold_var: !input battery_low_threshold

  # First light.* on the selected Inovelli device (used as LED target)
  inovelli_led_light: >
    {{ device_entities(inovelli_device_var)
       | select('match', '^light\\.')
       | list | first }}

  adaptive_enabled: >
    {{ adaptive_helper_var != [] and adaptive_script_var != [] }}

  daynight_enabled: >
    {{ light_group_var != [] }}

  # List of provided battery entities (skip blanks)
  battery_entities: >
    {{ [battery_entity_1_var, battery_entity_2_var, battery_entity_3_var, battery_entity_4_var]
       | reject('equalto', []) | list }}

  # Lowest battery % across provided sensors (101 if none/unknown)
  lowest_battery_pct: >
    {% set minv = 101 %}
    {% for e in battery_entities %}
      {% set v = states(e) | float(101) %}
      {% if v < minv %}{% set minv = v %}{% endif %}
    {% endfor %}
    {{ minv }}

  led_color_effective: >
    {% set threshold = battery_low_threshold_var | int(30) %}
    {{ 'Red' if (lowest_battery_pct | float(101)) < threshold else led_color_var }}

triggers:
  - trigger: device
    domain: mqtt
    device_id: !input inovelli_device
    type: action
    subtype: config_single
    id: SCENE_NIGHT

  - trigger: device
    domain: mqtt
    device_id: !input inovelli_device
    type: action
    subtype: config_double
    id: SCENE_DAY

  - trigger: device
    domain: mqtt
    device_id: !input inovelli_device
    type: action
    subtype: up_single
    id: ADAPT_LIVE

  - trigger: device
    domain: mqtt
    device_id: !input inovelli_device
    type: action
    subtype: down_single
    id: ADAPT_PRESTAGE

  - trigger: device
    domain: mqtt
    device_id: !input inovelli_device
    type: action
    subtype: up_held
    id: STOP_ADAPT

  - trigger: device
    domain: mqtt
    device_id: !input inovelli_device
    type: action
    subtype: down_held
    id: STOP_ADAPT

  - trigger: device
    domain: mqtt
    device_id: !input inovelli_device
    type: action
    subtype: up_double
    id: SHADES_UP

  - trigger: device
    domain: mqtt
    device_id: !input inovelli_device
    type: action
    subtype: down_double
    id: SHADES_DOWN

  - trigger: device
    domain: mqtt
    device_id: !input inovelli_device
    type: action
    subtype: up_triple
    id: SHADES_SHADY

conditions: []

actions:
  - choose:

      # ========== CONFIG BUTTON: DAY/NIGHT (only if light_group provided) ==========
      - conditions:
          - condition: trigger
            id:
              - SCENE_DAY
              - SCENE_NIGHT
        sequence:
          - if:
              - condition: template
                value_template: "{{ daynight_enabled }}"
            then:
              # Turn OFF Adaptive helper first only if adaptive is fully configured
              - if:
                  - condition: template
                    value_template: "{{ adaptive_enabled }}"
                then:
                  - action: input_boolean.turn_off
                    target:
                      entity_id: !input adaptive_helper
              # Apply Day/Night settings directly to the selected group/light (smooth transitions)
              - choose:
                  - conditions:
                      - condition: trigger
                        id: SCENE_DAY
                    sequence:
                      - action: light.turn_on
                        target:
                          entity_id: !input light_group
                        data:
                          brightness_pct: !input day_brightness
                          color_temp_kelvin: !input day_color_temp_k
                          transition: !input day_transition
                  - conditions:
                      - condition: trigger
                        id: SCENE_NIGHT
                    sequence:
                      - action: light.turn_on
                        target:
                          entity_id: !input light_group
                        data:
                          brightness_pct: !input night_brightness
                          color_temp_kelvin: !input night_color_temp_k
                          transition: !input night_transition
            else: []

      # ========== ADAPTIVE: LIVE / PRESTAGE / STOP ==========
      - conditions:
          - condition: trigger
            id:
              - ADAPT_LIVE
              - ADAPT_PRESTAGE
              - STOP_ADAPT
        sequence:
          - if:
              - condition: template
                value_template: "{{ adaptive_enabled }}"
            then:
              - choose:
                  # LIVE/PRESTAGE: only act if helper is OFF → turn ON, delay 0.5s, then run the script once
                  - conditions:
                      - condition: trigger
                        id:
                          - ADAPT_LIVE
                          - ADAPT_PRESTAGE
                      - condition: template
                        value_template: "{{ is_state(adaptive_helper_var, 'off') }}"
                    sequence:
                      - action: input_boolean.turn_on
                        target:
                          entity_id: !input adaptive_helper
                      - delay:
                          milliseconds: 500
                      - choose:
                          - conditions:
                              - condition: trigger
                                id: ADAPT_LIVE
                            sequence:
                              - action: script.turn_on
                                target:
                                  entity_id: !input adaptive_script
                                data:
                                  variables:
                                    target_state: "ON"
                          - conditions:
                              - condition: trigger
                                id: ADAPT_PRESTAGE
                            sequence:
                              - action: script.turn_on
                                target:
                                  entity_id: !input adaptive_script
                                data:
                                  variables:
                                    target_state: "OFF"

                  # If helper already ON for LIVE/PRESTAGE → do nothing (no script)
                  - conditions:
                      - condition: trigger
                        id:
                          - ADAPT_LIVE
                          - ADAPT_PRESTAGE
                      - condition: template
                        value_template: "{{ is_state(adaptive_helper_var, 'on') }}"
                    sequence: []

                  # STOP: always turn helper OFF
                  - conditions:
                      - condition: trigger
                        id: STOP_ADAPT
                    sequence:
                      - action: input_boolean.turn_off
                        target:
                          entity_id: !input adaptive_helper
            else: []

      # ========== SHADES (SCENES) + AUTO LED EFFECTS ==========
      - conditions:
          - condition: trigger
            id:
              - SHADES_UP
              - SHADES_DOWN
              - SHADES_SHADY
        sequence:
          # UP double
          - choose:
              - conditions:
                  - condition: trigger
                    id: SHADES_UP
                  - condition: template
                    value_template: "{{ shade_up_scene_var != [] }}"
                sequence:
                  - action: !input led_script
                    data:
                      led: "All"
                      color: "{{ led_color_effective }}"
                      level: "{{ led_level_var }}"
                      effect: "Slow Rising"
                      duration: "{{ led_duration_var }}"
                      target:
                        entity_id: "{{ inovelli_led_light }}"
                  - action: scene.turn_on
                    target:
                      entity_id: !input shade_up_scene

              # DOWN double
              - conditions:
                  - condition: trigger
                    id: SHADES_DOWN
                  - condition: template
                    value_template: "{{ shade_down_scene_var != [] }}"
                sequence:
                  - action: !input led_script
                    data:
                      led: "All"
                      color: "{{ led_color_effective }}"
                      level: "{{ led_level_var }}"
                      effect: "Slow Falling"
                      duration: "{{ led_duration_var }}"
                      target:
                        entity_id: "{{ inovelli_led_light }}"
                  - action: scene.turn_on
                    target:
                      entity_id: !input shade_down_scene

              # UP triple (“Shady”)
              - conditions:
                  - condition: trigger
                    id: SHADES_SHADY
                  - condition: template
                    value_template: "{{ shade_shady_scene_var != [] }}"
                sequence:
                  - action: !input led_script
                    data:
                      led: "All"
                      color: "{{ led_color_effective }}"
                      level: "{{ led_level_var }}"
                      effect: "Pulse"
                      duration: "{{ led_duration_var }}"
                      target:
                        entity_id: "{{ inovelli_led_light }}"
                  - action: scene.turn_on
                    target:
                      entity_id: !input shade_shady_scene

mode: single
